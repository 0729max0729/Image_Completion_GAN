<!-- templates/index.html -->
<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>Image Completion Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/main.css" />
</head>
<body>
  <div class="wrap">
    <h1>影像補全（TransformerGen）</h1>

    <form id="frm" onsubmit="return false;">
      <div class="row">
        <label>選擇圖片：</label>
        <input id="file" type="file" accept="image/*" required />
      </div>

      <div class="row">
        <label>遮罩大小 (像素)：</label>
        <input id="mask_size" type="number" min="16" max="224" value="100" />
      </div>

      <div class="row">
        <label>MC Dropout 次數（>1 會估不確定度）：</label>
        <input id="mc_samples" type="number" min="1" max="100" value="1" />
      </div>

      <div class="row">
        <button id="btn" onclick="doInpaint()">開始補全</button>
      </div>
    </form>

    <div id="loading" class="hide">處理中…</div>

    <div id="result" class="grid hide">
      <div class="cell">
        <h3>Original</h3>
        <img id="img_original" />
      </div>
      <div class="cell">
        <h3>Masked</h3>
        <img id="img_masked" />
      </div>
      <div class="cell">
        <h3>Completed</h3>
        <img id="img_completed" />
      </div>
      <div class="cell">
        <h3>Uncertainty</h3>
        <img id="img_uncertainty" />
      </div>
      <div class="cell">
        <h3>Residual</h3>
        <img id="img_residual" />
      </div>
    </div>
  </div>

<script>
async function doInpaint() {
  const file = document.getElementById('file').files[0];
  const maskSize = document.getElementById('mask_size').value;
  const mcSamples = document.getElementById('mc_samples').value;
  if (!file) { alert('請先選擇圖片'); return; }

  const fd = new FormData();
  fd.append('file', file, file.name);
  fd.append('mask_size', maskSize);
  fd.append('mc_samples', mcSamples);

  const loading = document.getElementById('loading');
  const result  = document.getElementById('result');
  loading.classList.remove('hide');
  result.classList.add('hide');

  try {
    const resp = await fetch('/inpaint', { method: 'POST', body: fd });
    const data = await resp.json();
    if (!resp.ok) { throw new Error(data.error || 'Server Error'); }

    document.getElementById('img_original').src   = data.original;
    document.getElementById('img_masked').src     = data.masked;
    document.getElementById('img_completed').src  = data.completed;
    document.getElementById('img_uncertainty').src= data.uncertainty;
    document.getElementById('img_residual').src   = data.residual;

    result.classList.remove('hide');
  } catch (err) {
    alert('發生錯誤：' + err.message);
  } finally {
    loading.classList.add('hide');
  }
}
</script>
</body>
</html>
